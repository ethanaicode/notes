# å¦‚ä½•ä½¿ç”¨ Nginx å±è”½æ¶æ„è¯·æ±‚å¹¶é˜²å¾¡åŸºç¡€æ”»å‡»

æœ€è¿‘ä¸€ä¸ªå›¾åºŠæœåŠ¡æ€»æ˜¯æ‰“å¼€ç‰¹åˆ«æ…¢ï¼ŒæŸ¥çœ‹äº†ä¸‹åå°æ—¥å¿—ï¼Œå‘ç°åœ¨è¢«é¢‘ç¹çš„æ”»å‡»ï¼Œè€Œä¸”è·å–åˆ°äº†æˆ‘çš„ç®¡ç†å‘˜è´¦å·ï¼Œä¸€ç›´åœ¨å°è¯•ç™»å½•ç®¡ç†å‘˜è´¦å·ã€‚

ä½†æ˜¯å› ä¸ºè¯·æ±‚ä¸»è¦ä»¥ `Bot` ä¸ºä¸»ï¼Œå°±åˆ¤æ–­å¯¹æ–¹ä¸ºæ­£å¸¸çš„çˆ¬è™«å§ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬ Nginx å°±å¯ä»¥æ‹¦æˆªã€‚

åœ¨ Nginx é…ç½®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **`map` è§„åˆ™ã€`limit_conn` å¹¶å‘é™åˆ¶ã€`limit_req` é€Ÿç‡é™åˆ¶ã€IP é»‘åå•ã€User-Agent å±è”½ã€Referer è¿‡æ»¤ã€é˜²ç«å¢™è§„åˆ™** ç­‰æ–¹æ³•æ¥æœ‰æ•ˆé˜²æ­¢ **æ¶æ„çˆ¬è™«ã€DDoS æ”»å‡»ã€æš´åŠ›æ‰«æã€åƒåœ¾æµé‡** ç­‰é—®é¢˜ã€‚

## **1. å±è”½æ¶æ„è¯·æ±‚çš„æ ¸å¿ƒæ‰‹æ®µ**

### **1.1. å±è”½æ¶æ„ User-Agent**

çˆ¬è™«ã€è‡ªåŠ¨åŒ–å·¥å…·ç»å¸¸ä½¿ç”¨ç‰¹å®šçš„ **User-Agent**ï¼Œå¯ä»¥é€šè¿‡ `map` è§„åˆ™å±è”½ï¼š

```nginx
http {
    map $http_user_agent $block_user_agent {
        default 0;
        "~*semrush" 1;
        "~*AhrefsBot" 1;
        "~*MJ12bot" 1;
    }

    server {
        listen 80;
        server_name shejibiji.com;

        location / {
            if ($block_user_agent) { return 444; }
        }
    }
}
```

ğŸ“Œ **è§£é‡Š**

- `~*` **ä¸åŒºåˆ†å¤§å°å†™**åŒ¹é… User-Agentã€‚

- `return 444;` **ç›´æ¥ä¸¢å¼ƒè¯·æ±‚ï¼Œä¸è¿”å›ä»»ä½•å“åº”**ï¼Œé˜²æ­¢æ¶æ„çˆ¬è™«ç»•è¿‡ã€‚

### **1.2. å±è”½æ¶æ„ Referer**

é˜²æ­¢åƒåœ¾å¤–é“¾ã€ç›—é“¾ã€SEO åƒåœ¾æµé‡ï¼š

```nginx
http {
    map $http_referer $block_referrer {
        default 0;
        "~*viagra" 1;
        "~*casino" 1;
        "~*porn" 1;
    }

    server {
        listen 80;
        server_name she ji bi ji;

        location / {
            if ($block_referrer) { return 403; }
        }
    }
}
```

ğŸ“Œ **è§£é‡Š**

- è¿‡æ»¤ **Referer ä¸­åŒ…å«è¿ç¦è¯çš„è¯·æ±‚**ï¼Œé˜²æ­¢åƒåœ¾å¤–é“¾æµé‡ã€‚

### **1.3. å±è”½ç‰¹å®š URL è®¿é—®**

å¯ä»¥é™åˆ¶æŸäº›æ•æ„Ÿè·¯å¾„ï¼Œå¦‚ `/admin`ã€`/phpmyadmin`ã€`/shejibiji`ï¼š

```nginx
http {
    map $request_uri $block_url {
        default 0;
        "~*^/admin" 1;
        "~*^/phpmyadmin" 1;
        "~*^/shejibiji" 1;
    }

    server {
        listen 80;
        server_name shejibiji.com;

        location / {
            if ($block_url) { return 444; }
        }
    }
}
```

ğŸ“Œ **è§£é‡Š**

- `^/admin` **æ‹¦æˆªæ‰€æœ‰è®¿é—® `/admin` åŠå…¶å­è·¯å¾„çš„è¯·æ±‚**ã€‚
- `return 444;` ç›´æ¥ä¸¢å¼ƒè¯·æ±‚ï¼Œé˜²æ­¢æ¢æµ‹æ‰«æã€‚

### **1.4. å±è”½ç‰¹å®š IP**

å¦‚æœä½ å‘ç°æŸäº› IP **é¢‘ç¹è®¿é—®ç½‘ç«™ã€æ”»å‡»æœåŠ¡å™¨**ï¼Œå¯ä»¥ç›´æ¥å±è”½ï¼š

```nginx
http {
    map $remote_addr $block_ip {
        default 0;
        "192.168.1.100" 1;
        "203.0.113.50" 1;
    }

    server {
        listen 80;
        server_name shejibiji.com;

        location / {
            if ($block_ip) { return 444; }
        }
    }
}
```

ğŸ“Œ **è§£é‡Š**

- å¯ä»¥ä½¿ç”¨ `map` **é›†ä¸­ç®¡ç† IP é»‘åå•**ï¼Œæ¯” `deny` æ›´ç›´è§‚ã€‚

### **1.5. å±è”½ Headers ä¼ªé€ æ”»å‡»**

æœ‰äº›æ”»å‡»è€…ä¼šä¼ªé€  HTTP å¤´éƒ¨è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¦æˆªï¼š

```nginx
if ($http_content_type ~* "(?:multipart/mixed|application/x-shellscript)") {
    return 403;
}
```

ğŸ“Œ **è§£é‡Š**

- **é˜»æ­¢ä¼ªé€  `Content-Type` çš„æ¶æ„è¯·æ±‚**ï¼ˆå¦‚ shell ä¸Šä¼ ï¼‰ã€‚

## **2. é™åˆ¶å¹¶å‘è¿æ¥ & é€Ÿç‡**

### **2.1. é™åˆ¶ IP å¹¶å‘è¿æ¥**

é™åˆ¶ **å•ä¸ª IP å…è®¸çš„æœ€å¤§è¿æ¥æ•°**ï¼Œé˜²æ­¢å ç”¨æœåŠ¡å™¨èµ„æºï¼š

```nginx
http {
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    server {
        listen 80;
        server_name shejibiji.com;

        location / {
            limit_conn conn_limit 50;
        }
    }
}
```

ğŸ“Œ **è§£é‡Š**

- `limit_conn_zone $binary_remote_addr` **æŒ‰ IP è®¡ç®—è¿æ¥æ•°**ã€‚
- `limit_conn conn_limit 50;` **å•ä¸ª IP æœ€å¤š 50 ä¸ªå¹¶å‘è¿æ¥**ã€‚

### **2.2. é™åˆ¶è¯·æ±‚é€Ÿç‡**

é˜²æ­¢ DDoS æ”»å‡»ã€çˆ¬è™«çŸ­æ—¶é—´å†…è¿‡å¤šè¯·æ±‚ï¼š

```nginx
http {
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;

    server {
        listen 80;
        server_name shejibiji.com;

        location / {
            limit_req zone=req_limit burst=20 nodelay;
        }
    }
}
```

ğŸ“Œ **è§£é‡Š**

- `rate=10r/s` â†’ **æ¯ä¸ª IP æ¯ç§’æœ€å¤š 10 ä¸ªè¯·æ±‚**ã€‚

- `burst=20` â†’ **å…è®¸çªå‘ 20 ä¸ªè¯·æ±‚**ï¼ˆè¶…å‡ºä¼šè¢«æ‹’ç»ï¼‰ã€‚

- `nodelay` â†’ **ç«‹å³ä¸¢å¼ƒè¶…é™è¯·æ±‚ï¼Œè€Œä¸æ˜¯æ’é˜Ÿæ‰§è¡Œ**ã€‚

## **3. ä½¿ç”¨ Nginx ç‰¹æ®ŠçŠ¶æ€ç **

| **çŠ¶æ€ç ** | **ä½œç”¨**                         | **ç”¨é€”**             |
| ---------- | -------------------------------- | -------------------- |
| `444`      | **ç›´æ¥ä¸¢å¼ƒè¯·æ±‚ï¼Œä¸è¿”å›ä»»ä½•å“åº”** | å±è”½çˆ¬è™«ã€æ”»å‡»è€…     |
| `495`      | **SSL è¯ä¹¦é”™è¯¯**                 | é˜»æ­¢æ— æ•ˆ SSL è¯ä¹¦    |
| `496`      | **éœ€è¦ SSL è¯ä¹¦**                | åªå…è®¸å¯ä¿¡å®¢æˆ·ç«¯è®¿é—® |
| `497`      | **HTTP è®¿é—® HTTPS ç«¯å£**         | è‡ªåŠ¨è·³è½¬åˆ° HTTPS     |
| `499`      | **å®¢æˆ·ç«¯æå‰å…³é—­è¿æ¥**           | æ—¥å¿—è®°å½•             |

ğŸ“Œ **ç¤ºä¾‹**

```nginx
error_page 495 =444;
error_page 496 =403;
```

## **4. æœåŠ¡å™¨ç«¯å®‰å…¨é˜²æŠ¤**

### **4.1. éšè—æœåŠ¡å™¨ä¿¡æ¯**

é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginx ä¼šåœ¨ `Server` å¤´éƒ¨æš´éœ²æœåŠ¡å™¨ä¿¡æ¯ï¼š

```nginx
server_tokens off;
```

ğŸ“Œ **ä½œç”¨**

- **éšè— Nginx ç‰ˆæœ¬å·**ï¼Œé˜²æ­¢é»‘å®¢åˆ©ç”¨å·²çŸ¥æ¼æ´æ”»å‡»ã€‚

### **4.2. é˜²æ­¢ `clickjacking`**

```nginx
add_header X-Frame-Options DENY;
```

ğŸ“Œ **ä½œç”¨**

- é˜²æ­¢**ç½‘ç«™è¢«åµŒå¥—åˆ° iframe å†…**ï¼Œé˜²æ­¢ç‚¹å‡»åŠ«æŒã€‚

### **4.3. é˜²æ­¢ `XSS` æ”»å‡»**

```nginx
add_header X-XSS-Protection "1; mode=block";
```

ğŸ“Œ **ä½œç”¨**

- å¯ç”¨æµè§ˆå™¨ XSS è¿‡æ»¤ï¼Œé˜²æ­¢**è·¨ç«™è„šæœ¬æ”»å‡»**ã€‚

## **5. ç»“åˆ Fail2Ban åŠ¨æ€å°ç¦**

å¦‚æœæŸäº› IP é¢‘ç¹æ”»å‡»æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `fail2ban` è¿›è¡ŒåŠ¨æ€å°ç¦ï¼š

1. **åˆ›å»ºè¿‡æ»¤è§„åˆ™**

   ```sh
   sudo nano /etc/fail2ban/filter.d/nginx-badbot.conf
   ```

   **è§„åˆ™å†…å®¹**

   ```csharp
   [Definition]
   failregex = .*"(GET|POST).*HTTP/.*" 403
   ```

2. **æ·»åŠ åˆ° `jail.local`**

   ```sh
   sudo nano /etc/fail2ban/jail.local
   ```

   **é…ç½®**

   ```makefile
   [nginx-badbot]
   enabled = true
   filter = nginx-badbot
   logpath = /var/log/nginx/access.log
   maxretry = 5
   findtime = 60
   bantime = 3600
   ```

3. **å¯åŠ¨ `fail2ban`**

   ```sh
   sudo systemctl restart fail2ban
   ```

## **ğŸ¯ ç»“è®º**

âœ… **å±è”½ User-Agentã€Refererã€IPã€URL**ï¼Œé˜²æ­¢æ¶æ„çˆ¬è™«ã€‚

âœ… **é™åˆ¶å¹¶å‘è¿æ¥ã€è¯·æ±‚é€Ÿç‡**ï¼Œé˜²æ­¢ DDoS æ”»å‡»ã€‚

âœ… **ä½¿ç”¨ `return 444` ç›´æ¥ä¸¢å¼ƒæ¶æ„è¯·æ±‚**ã€‚

âœ… **å¼€å¯ Nginx å®‰å…¨å¤´ã€éšè—æœåŠ¡å™¨ä¿¡æ¯ï¼Œé˜²æ­¢ä¿¡æ¯æ³„éœ²**ã€‚

âœ… **ç»“åˆ `fail2ban` è¿›è¡ŒåŠ¨æ€å°ç¦ï¼Œè‡ªåŠ¨å±è”½æ”»å‡» IP**ã€‚

ğŸš€ é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œå¯ä»¥å¤§å¹…æå‡ Nginx æœåŠ¡å™¨çš„**å®‰å…¨æ€§å’Œç¨³å®šæ€§**ï¼
